<!--
web_odp_converter.html

Page web (frontend) pour uploader un fichier .odp et demander l'export de chaque diapositive individuellement.

IMPORTANT : Le navigateur ne peut pas convertir les fichiers .odp en images tout seul. Ce fichier HTML fournit une interface (drag & drop / choix de fichier) et envoie le .odp à un backend (/api/convert) qui devra exécuter LibreOffice (soffice) en mode headless pour convertir puis renvoyer un ZIP contenant les images (slide_001.png, ...).

Exemple de backend Node.js (à coller dans un fichier server.js) :

// --- server.js (exemple minimal) ---
// Prérequis: Node.js, npm install express multer adm-zip child_process
// LibreOffice installé (soffice accessible via PATH)

/*
const express = require('express');
const multer = require('multer');
const { execFile } = require('child_process');
const fs = require('fs');
const path = require('path');
const AdmZip = require('adm-zip');

const upload = multer({ dest: 'uploads/' });
const app = express();

app.post('/api/convert', upload.single('file'), (req, res) => {
  if (!req.file) return res.status(400).json({ error: 'Aucun fichier reçu' });
  const inputPath = path.resolve(req.file.path);
  const outDir = path.resolve('out', path.parse(req.file.originalname).name + '_' + Date.now());
  fs.mkdirSync(outDir, { recursive: true });
  // Utilise soffice pour convertir en PNG
  const soffice = 'soffice'; // ou chemin complet vers soffice
  execFile(soffice, ['--headless', '--convert-to', 'png', '--outdir', outDir, inputPath], (err, stdout, stderr) => {
    if (err) {
      console.error(err, stderr);
      return res.status(500).json({ error: 'Erreur de conversion', details: stderr || err.message });
    }
    // Récupère les fichiers PNG générés
    const files = fs.readdirSync(outDir).filter(f => /\.(png|jpg|jpeg|svg|pdf)$/i.test(f));
    // Renomme et ordonne si besoin
    files.sort();
    files.forEach((f, i) => {
      const src = path.join(outDir, f);
      const dst = path.join(outDir, `slide_${String(i+1).padStart(3,'0')}${path.extname(f)}`);
      fs.renameSync(src, dst);
    });
    // Création du ZIP
    const zip = new AdmZip();
    fs.readdirSync(outDir).forEach(f => zip.addLocalFile(path.join(outDir, f)));
    const zipBuffer = zip.toBuffer();
    // Cleanup (optionnel)
    fs.unlinkSync(inputPath);
    // Envoi du ZIP
    res.set('Content-Disposition', `attachment; filename="${path.parse(req.file.originalname).name}_slides.zip"`);
    res.set('Content-Type', 'application/zip');
    res.send(zipBuffer);
  });
});

app.listen(3000, () => console.log('Server running on http://localhost:3000'));
*/

-->

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Export ODP → Slides individuelles</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa4b2;color-scheme: dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;margin:0;background:linear-gradient(180deg,#071022 0%, #07142a 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:rgba(255,255,255,0.03);padding:24px;border-radius:12px;max-width:820px;width:100%;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .uploader{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
    .drop{border:2px dashed rgba(255,255,255,0.06);padding:22px;border-radius:10px;min-height:180px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;text-align:center}
    .drop.dragover{border-color:rgba(6,182,212,0.7);box-shadow:0 8px 30px rgba(6,182,212,0.08)}
    input[type=file]{display:none}
    .controls{display:flex;flex-direction:column;gap:12px}
    button{background:linear-gradient(90deg,rgba(6,182,212,0.12),rgba(99,102,241,0.06));border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:8px;color:#e6eef6;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    progress{width:100%}
    .log{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-family:monospace;font-size:13px;color:var(--muted);min-height:72px;overflow:auto}
    a.link{color:var(--accent);text-decoration:none}
    footer{margin-top:14px;font-size:12px;color:var(--muted)}
    @media (max-width:820px){.uploader{grid-template-columns:1fr}} 
  </style>
</head>
<body>
  <div class="card">
    <h1>Exporter les slides d'un .odp (frontend)</h1>
    <p class="lead">Glissez-déposez votre fichier <strong>.odp</strong> ou sélectionnez-le. Le fichier est envoyé au serveur qui doit exécuter LibreOffice pour générer les images puis renvoyer un ZIP.</p>

    <div class="uploader">
      <div>
        <div id="drop" class="drop">
          <div id="dropContent">
            <strong>Déposez votre fichier .odp ici</strong>
            <div class="small">ou</div>
            <label for="fileInput" style="cursor:pointer;color:var(--accent);text-decoration:underline">Choisir un fichier</label>
            <input id="fileInput" type="file" accept=".odp,application/vnd.oasis.opendocument.presentation" />
            <div id="fileName" class="small" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="uploadBtn">Envoyer et convertir</button>
          <button id="resetBtn">Réinitialiser</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Progression :</div>
          <progress id="progress" value="0" max="100" style="height:14px;border-radius:8px"></progress>
        </div>
      </div>

      <div class="controls">
        <div>
          <div class="small"><strong>Options</strong></div>
          <label class="small">Format de sortie (côté serveur) :</label>
          <select id="formatSelect">
            <option value="png">PNG (recommandé)</option>
            <option value="jpg">JPG</option>
            <option value="pdf">PDF (LibreOffice peut produire un seul PDF)</option>
          </select>
        </div>

        <div>
          <div class="small"><strong>Journal</strong></div>
          <div id="log" class="log">Prêt. Le backend attendu : <code>POST /api/convert</code> (form field: <code>file</code>, option: <code>format</code>).</div>
        </div>

        <div>
          <div class="small"><strong>Serveur</strong></div>
          <div class="small">Par défaut : <code>http://localhost:3000/api/convert</code></div>
          <div class="small">Le serveur doit renvoyer un fichier ZIP en réponse. Voir le commentaire en haut pour un exemple Node.js.</div>
        </div>

      </div>
    </div>

    <footer>
      <div>Besoin d'un backend prêt à l'emploi ? Dites-moi si vous voulez que j'ajoute le code serveur dans un fichier séparé (Node.js + Express + LibreOffice) ou en Python (Flask).</div>
    </footer>
  </div>

<script>
(() => {
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const fileName = document.getElementById('fileName');
  const uploadBtn = document.getElementById('uploadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const progress = document.getElementById('progress');
  const log = document.getElementById('log');
  const formatSelect = document.getElementById('formatSelect');

  let selectedFile = null;

  function logMsg(s){
    log.textContent = s + '\n' + log.textContent;
  }

  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', e => { e.preventDefault(); drop.classList.remove('dragover'); });
  drop.addEventListener('drop', e => {
    e.preventDefault(); drop.classList.remove('dragover');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    handleFile(f);
  });

  fileInput.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    handleFile(f);
  });

  function handleFile(f){
    if (!f) return;
    if (!f.name.toLowerCase().endsWith('.odp')){
      alert('Veuillez sélectionner un fichier .odp');
      return;
    }
    selectedFile = f;
    fileName.textContent = `${f.name} — ${Math.round(f.size/1024)} KB`;
    logMsg('Fichier prêt : ' + f.name);
  }

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile){ alert('Aucun fichier sélectionné'); return; }
    uploadBtn.disabled = true;
    resetBtn.disabled = true;
    logMsg('Envoi du fichier au serveur...');
    progress.value = 5;

    const url = (new URL('/api/convert', window.location.href)).toString();
    const form = new FormData();
    form.append('file', selectedFile);
    form.append('format', formatSelect.value);

    try{
      const resp = await fetch(url, { method: 'POST', body: form });
      if (!resp.ok) {
        const txt = await resp.text();
        logMsg('Erreur serveur: ' + resp.status + ' — ' + txt);
        uploadBtn.disabled = false; resetBtn.disabled = false; progress.value = 0;
        return;
      }
      // lecture du blob (zip)
      const contentDisposition = resp.headers.get('Content-Disposition') || '';
      let filename = 'slides.zip';
      const m = /filename\*=UTF-8''([^;]+)/i.exec(contentDisposition) || /filename="?([^";]+)"?/i.exec(contentDisposition);
      if (m) filename = decodeURIComponent(m[1]);

      const reader = resp.body.getReader();
      const contentLength = +resp.headers.get('Content-Length') || 0;
      let received = 0;
      const chunks = [];
      while (true){
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (contentLength) progress.value = Math.round(5 + 95 * (received / contentLength));
      }
      // concaténation
      let blob = new Blob(chunks, { type: 'application/zip' });
      progress.value = 100;
      logMsg('Réception terminée — préparation du téléchargement');
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      logMsg('Téléchargement déclenché : ' + filename);

    } catch (err){
      console.error(err);
      logMsg('Erreur: ' + (err.message || err));
    } finally{
      uploadBtn.disabled = false; resetBtn.disabled = false; progress.value = 0;
    }
  });

  resetBtn.addEventListener('click', () => {
    selectedFile = null; fileInput.value = ''; fileName.textContent = ''; logMsg('Réinitialisé');
  });

})();
</script>
</body>
</html>
