<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convertisseur ODP → HTML</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
.controls { margin-bottom: 20px; }
.slide { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
.img-slide { max-width: 100%; margin-top: 10px; }
</style>
</head>
<body>
<h1>Convertisseur ODP → HTML (client-side)</h1>
<div class="controls">
  <input type="file" id="file" accept=".odp">
  <button id="convert">Convertir</button>
</div>
<div id="status"></div>
<div id="slides"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const fileInput = document.getElementById('file');
const convertBtn = document.getElementById('convert');
const slidesContainer = document.getElementById('slides');
const status = document.getElementById('status');

function setStatus(msg){ status.textContent = msg; }

convertBtn.addEventListener('click', async ()=>{
  const f = fileInput.files[0];
  if(!f) return alert('Choisissez un fichier .odp');
  setStatus('Lecture du fichier...');
  slidesContainer.innerHTML = '';

  try{
    const arrayBuffer = await f.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    if(!zip.files['content.xml']) return setStatus('Fichier invalide : content.xml manquant');

    const contentXml = await zip.files['content.xml'].async('string');
    const parser = new DOMParser();
    const doc = parser.parseFromString(contentXml,'application/xml');

    const slideNodes = Array.from(doc.getElementsByTagName('draw:page'));
    setStatus(`Extraction de ${slideNodes.length} slides...`);

    const allSlidesHTML = [];

    for(let i=0;i<slideNodes.length;i++){
      const slideNode = slideNodes[i];
      let slideHTML = `<article class=\"slide\">`;

      // Texte
      const texts = Array.from(slideNode.getElementsByTagName('text:p')).map(n=>n.textContent.trim()).filter(t=>t.length>0);
      if(texts.length){
        texts.forEach(t=>{ slideHTML += `<p>${t}</p>`; });
      } else {
        slideHTML += `<p style=\"opacity:0.7\">(aucun texte détecté)</p>`;
      }

      // Images
      const imgNodes = Array.from(slideNode.getElementsByTagName('draw:image'));
      for(const imgNode of imgNodes){
        const href = imgNode.getAttribute('xlink:href');
        if(href && zip.files[href.replace(/^\//,'')]){
          const blob = await zip.files[href.replace(/^\//,'')].async('blob');
          const url = URL.createObjectURL(blob);
          slideHTML += `<img src=\"${url}\" class=\"img-slide\">`;
        }
      }

      slideHTML += '</article>';
      allSlidesHTML.push(slideHTML);
    }

    // Affiche toutes les slides
    slidesContainer.innerHTML = allSlidesHTML.join('');

    // Bouton pour télécharger toutes les slides en un seul fichier HTML
    const dlAllBtn = document.createElement('button');
    dlAllBtn.textContent = 'Télécharger toutes les slides en un seul HTML';
    dlAllBtn.style.marginBottom = '20px';
    dlAllBtn.addEventListener('click',()=>{
      const blob = new Blob([`<html><head><meta charset=\"utf-8\"></head><body>${allSlidesHTML.join('')}</body></html>`],{type:'text/html'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='toutes_slides.html'; a.click();
    });
    slidesContainer.prepend(dlAllBtn);

    setStatus('Conversion terminée.');

  }catch(err){
    console.error(err);
    setStatus('Erreur : ' + (err.message || err));
  }
});
</script>
</body>
</html>
