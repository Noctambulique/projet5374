#!/usr/bin/env python3
"""
export_odp_slides.py

Export all slides from a .odp (OpenDocument Presentation) as individual image/pdf files.
Uses LibreOffice (soffice) in headless mode or unoconv (if available).

Usage:
    python export_odp_slides.py input_file.odp --outdir slides --format png

Requirements:
    - LibreOffice (soffice) installed and in PATH  OR
    - unoconv installed and in PATH
    - Python 3.7+
"""
import argparse
import shutil
import subprocess
import sys
from pathlib import Path
import glob
import re

def find_converter():
    """Return which converter is available: 'soffice', 'unoconv' or None."""
    if shutil.which("soffice"):
        return "soffice"
    if shutil.which("unoconv"):
        return "unoconv"
    return None

def call_soffice_convert(input_path: Path, outdir: Path, target_format: str):
    """
    Call LibreOffice soffice to convert the presentation.
    Example: soffice --headless --convert-to png --outdir outdir file.odp
    """
    cmd = [
        "soffice",
        "--headless",
        "--convert-to", target_format,
        "--outdir", str(outdir),
        str(input_path)
    ]
    print("Exécution:", " ".join(cmd))
    subprocess.run(cmd, check=True)

def call_unoconv_convert(input_path: Path, outdir: Path, target_format: str):
    """
    Call unoconv to convert.
    Example: unoconv -f png -o outdir file.odp
    """
    cmd = [
        "unoconv",
        "-f", target_format,
        "-o", str(outdir),
        str(input_path)
    ]
    print("Exécution:", " ".join(cmd))
    subprocess.run(cmd, check=True)

def gather_generated_files(outdir: Path, base_name: str, target_exts):
    """
    List generated files in outdir that belong to the converted presentation.
    We look for files containing base_name or starting with base_name.
    """
    files = []
    # Find all files in outdir with matching extensions
    for ext in target_exts:
        pattern = str(outdir / f"{base_name}*{ext}")
        found = glob.glob(pattern)
        files.extend(found)
    # If nothing found with base_name, add any matching extension (fallback)
    if not files:
        for ext in target_exts:
            files.extend(glob.glob(str(outdir / f"*{ext}")))
    # remove duplicates and sort deterministically
    files = sorted(set(files), key=lambda p: natural_sort_key(Path(p).name))
    return [Path(p) for p in files]

def natural_sort_key(s):
    """Key for human-friendly sorting (numbers in filenames sorted numerically)."""
    return [int(text) if text.isdigit() else text.lower() for text in re.split(r'(\d+)', s)]

def rename_slides(files, outdir: Path, output_format: str, prefix="slide_"):
    """
    Rename/move files to standardized output names: slide_001.png, slide_002.png, ...
    Returns list of produced file paths.
    """
    produced = []
    digits = max(3, len(str(len(files))))
    for i, f in enumerate(files, start=1):
        new_name = f"{prefix}{i:0{digits}d}.{output_format}"
        dest = outdir / new_name
        # If target exists, overwrite
        try:
            f.replace(dest)
        except Exception:
            # fallback to copy if replace fails (permissions etc.)
            import shutil
            shutil.copy2(f, dest)
            try:
                f.unlink()
            except Exception:
                pass
        produced.append(dest)
    return produced

def main():
    parser = argparse.ArgumentParser(description="Exporter toutes les slides d'un .odp individuellement.")
    parser.add_argument("input", type=str, help="Fichier .odp à convertir")
    parser.add_argument("--outdir", "-o", type=str, default="slides", help="Dossier de sortie")
    parser.add_argument("--format", "-f", type=str, default="png", choices=["png","jpg","svg","pdf"],
                        help="Format de sortie des slides (png/jpg/svg/pdf)")
    parser.add_argument("--keep-original-names", action="store_true",
                        help="Ne pas renommer les fichiers générés, laisser les noms originaux")
    args = parser.parse_args()

    input_path = Path(args.input).expanduser().resolve()
    if not input_path.exists():
        print(f"Fichier introuvable: {input_path}", file=sys.stderr)
        sys.exit(2)

    outdir = Path(args.outdir).expanduser().resolve()
    outdir.mkdir(parents=True, exist_ok=True)

    converter = find_converter()
    if converter is None:
        print("Aucun convertisseur trouvé. Installez LibreOffice (soffice) ou unoconv et réessayez.", file=sys.stderr)
        sys.exit(3)

    target_format = args.format
    print(f"Utilisation du convertisseur: {converter}")
    try:
        if converter == "soffice":
            # For some versions specifying filter is helpful, but --convert-to <fmt> usually works.
            call_soffice_convert(input_path, outdir, target_format)
        else:
            call_unoconv_convert(input_path, outdir, target_format)
    except subprocess.CalledProcessError as e:
        print("Erreur lors de la conversion :", e, file=sys.stderr)
        sys.exit(4)

    base_name = input_path.stem
    # expected extensions
    ext = target_format.lower()
    target_exts = [f".{ext}"]
    generated = gather_generated_files(outdir, base_name, target_exts)

    if not generated:
        print("Aucune sortie trouvée après conversion. Vérifiez que le convertisseur a fonctionné correctement.", file=sys.stderr)
        # list files in outdir for debugging
        print("Contenu du dossier de sortie:", outdir)
        for p in sorted(outdir.iterdir()):
            print(" -", p.name)
        sys.exit(5)

    if args.keep_original_names:
        print("Fichiers générés (conserver noms originaux):")
        for p in generated:
            print(" -", p.name)
        print(f"Téléchargement terminé. Fichiers dans: {outdir}")
        return

    produced = rename_slides(generated, outdir, ext)
    print("Export terminé. Fichiers produits:")
    for p in produced:
        print(" -", p.name)
    print(f"Tous les slides sont disponibles dans: {outdir}")

if __name__ == "__main__":
    main()
